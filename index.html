<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Performance Excel Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .dashboard-container {
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            box-sizing: border-box;
        }

        header {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            color: #1a237e;
        }

        .file-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        input[type="file"] {
            border: 2px dashed #ccc;
            padding: 15px;
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }
        
        input[type="file"]::file-selector-button {
            border: 1px solid #ddd;
            padding: 8px 12px;
            background-color: #eee;
            border-radius: 6px;
            cursor: pointer;
        }

        .kpi-cards, .insights-container, .comparison-panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .kpi-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.2s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #555;
        }

        .kpi-card p {
            margin: 5px 0 0;
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a237e;
        }
        
        .comparison-panel {
            display: none; /* Initially hidden */
            margin-top: 20px;
            flex-direction: column;
        }
        
        .comparison-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: flex-start;
        }
        
        .comparison-card {
            background-color: #f0f4f7;
            padding: 15px;
            border-radius: 10px;
            flex: 1 1 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .comparison-card h4 {
            margin-top: 0;
            text-align: center;
            color: #1a237e;
        }
        
        .comparison-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .comparison-metric span {
            font-size: 0.9rem;
        }
        
        .better-metric {
            font-weight: 700;
            color: #28a745;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .controls-container {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .controls-container input, .controls-container select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: inherit;
        }

        .controls-container label {
            font-weight: 500;
            color: #555;
        }
        
        .insights-container h2 {
            margin-top: 0;
            color: #1a237e;
        }
        
        .insights-container ul {
            list-style-type: disc;
            padding-left: 20px;
            margin: 0;
        }
        
        .insights-container li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .table-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .profile-table {
            width: 100%;
            border-collapse: collapse;
        }

        .profile-table th, .profile-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .profile-table th {
            background-color: #eef1f3;
            cursor: pointer;
            position: relative;
        }

        .profile-table th::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid #aaa;
            opacity: 0.5;
        }

        .profile-table th.asc::after {
            border-bottom: none;
            border-top: 5px solid #555;
            opacity: 1;
        }

        .profile-table th.desc::after {
            border-bottom: 5px solid #555;
            opacity: 1;
        }
        
        .profile-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .profile-table tr.drilldown-row {
            background-color: #f0f4f7;
        }

        .drilldown-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        
        .drilldown-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .modal-table th, .modal-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        
        .modal-table th {
            background-color: #f1f1f1;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #777;
            font-size: 0.9rem;
        }
        
        .export-buttons button {
            background-color: #1a237e;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        
        .export-buttons button:hover {
            background-color: #3f51b5;
        }
        
        /* Multi-select styling */
        .select-container {
            position: relative;
            width: 250px;
        }
        
        .select-box {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .select-box::after {
            content: '▼';
            font-size: 0.8em;
            color: #888;
        }
        
        .options-container {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-top: none;
            background-color: #fff;
            z-index: 10;
            border-radius: 0 0 8px 8px;
            display: none;
        }
        
        .options-container label {
            display: block;
            padding: 8px 10px;
            cursor: pointer;
        }
        
        .options-container label:hover {
            background-color: #f1f1f1;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            .kpi-cards, .charts-container {
                grid-template-columns: 1fr;
            }
            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }
            .controls-container label {
                width: 100%;
                text-align: left;
                margin-bottom: 5px;
            }
            .controls-container input, .controls-container select, .select-container {
                width: 100%;
            }
            .export-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .export-buttons button {
                margin: 0;
            }
            .comparison-cards-container {
                flex-direction: column;
            }
        }
        
    </style>
</head>
<body>

<div class="dashboard-container">
    <header>
        <h1 id="dashboard-title">Shorts Performance Dashboard</h1>
        <div class="file-upload-container">
            <label for="file-upload">Upload your data (Excel .xlsx):</label>
            <input type="file" id="file-upload" accept=".xlsx">
        </div>
    </header>

    <main>
        <div class="kpi-cards" id="kpi-cards">
            <div class="kpi-card">
                <h3>Total Titles</h3>
                <p id="kpi-titles">0</p>
            </div>
            <div class="kpi-card">
                <h3>Total Clips</h3>
                <p id="kpi-clips">0</p>
            </div>
            <div class="kpi-card">
                <h3>Total Views</h3>
                <p id="kpi-views">0</p>
            </div>
            <div class="kpi-card">
                <h3>Avg Views per Clip</h3>
                <p id="kpi-avg-views-per-clip">0</p>
            </div>
            <div class="kpi-card">
                <h3>Overall Avg/View (Conversion)</h3>
                <p id="kpi-avg-per-view-conversion">0.000</p>
            </div>
        </div>
        
        <div class="insights-container">
            <h2>Insights</h2>
            <div id="insights-text">
                <p>Upload an Excel file to generate insights.</p>
            </div>
        </div>

        <div class="controls-container">
            <label for="search-title">Search Title:</label>
            <input type="text" id="search-title" placeholder="e.g., Cool Vids">
            
            <label for="min-views">Min Views:</label>
            <input type="number" id="min-views" value="0">

            <label for="max-views">Max Views:</label>
            <input type="number" id="max-views" value="999999999">
            
            <label for="min-avg-per-view">Min Avg/View (Conversion):</label>
            <input type="number" id="min-avg-per-view" value="0" step="0.001">
            
            <label for="sort-by">Sort by:</label>
            <select id="sort-by">
                <option value="total_views">Total Views</option>
                <option value="avg_views_per_clip">Avg Views/Clip</option>
                <option value="avg_per_view_conversion">Avg/View (Conversion)</option>
                <option value="total_likes">Total Likes</option>
                <option value="total_watched_clicks">Total Watched Clicks</option>
            </select>
            
            <label for="top-n">Top N:</label>
            <input type="number" id="top-n" value="10" min="1" max="100">
            
            <div class="select-container">
                <div class="select-box" id="comparison-select-box">
                    <span>Compare Titles</span>
                </div>
                <div class="options-container" id="comparison-options"></div>
            </div>
        </div>
        
        <div class="comparison-panel" id="comparison-panel">
            <h2>Comparison Panel</h2>
            <div class="comparison-cards-container" id="comparison-cards"></div>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <canvas id="viewsChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="avgPerViewChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="scatterChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="stackedBarChart"></canvas>
            </div>
        </div>

        <div class="table-container">
            <h2>Performance Table</h2>
            <table class="profile-table" id="profile-table">
                <thead>
                    <tr>
                        <th data-column="title">Title</th>
                        <th data-column="clips">Clips</th>
                        <th data-column="total_views">Total Views</th>
                        <th data-column="total_likes">Total Likes</th>
                        <th data-column="total_watched_clicks">Total Watched Clicks</th>
                        <th data-column="avg_views_per_clip">Avg Views/Clip</th>
                        <th data-column="avg_per_view_conversion">Avg/View (Conversion)</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Table rows will be inserted here -->
                </tbody>
            </table>
            <div class="pagination-controls" id="pagination-controls"></div>
        </div>
    </main>
    
    <div id="drilldown-modal" class="drilldown-modal">
        <div class="drilldown-content">
            <span class="close-button">&times;</span>
            <h2 id="drilldown-profile-title"></h2>
            <div id="drilldown-table-container">
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>Arabic Title</th>
                            <th>Views</th>
                            <th>Likes</th>
                            <th>Watched Clicks</th>
                        </tr>
                    </thead>
                    <tbody id="drilldown-table-body">
                        <!-- Clip details will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <p>Data source: User uploaded Excel data. "Titles" column mapped to "profile".</p>
        <div class="export-buttons">
            <button id="export-csv">Export Table to CSV</button>
            <button id="export-png">Export Charts to PNG</button>
        </div>
    </footer>
</div>

<script>
    // Sample data to load on page initialization
    const sampleData = [
        {"Titles": "Holm Esref", "ArabicTitle": "محتوى عربي 1", "Media Played": "150000", "Likes": 1500, "Watched Clicked": 15000},
        {"Titles": "Holm Esref", "ArabicTitle": "محتوى عربي 2", "Media Played": "174892", "Likes": 1748, "Watched Clicked": 17489},
        {"Titles": "Titles", "ArabicTitle": "محتوى عربي", "Media Played": "15K", "Likes": 500, "Watched Clicked": 250},
        {"Titles": "Titles", "ArabicTitle": "محتوى جديد", "Media Played": "22,000", "Likes": 800, "Watched Clicked": 400},
        {"Titles": "Clips Hub", "ArabicTitle": "قناة شورتس", "Media Played": "35K", "Likes": 1200, "Watched Clicked": 700},
        {"Titles": "Clips Hub", "ArabicTitle": "مركز المقاطع", "Media Played": "18,000", "Likes": 600, "Watched Clicked": 300},
        {"Titles": "Clips Hub", "ArabicTitle": "مقاطع يومية", "Media Played": "45K", "Likes": 1500, "Watched Clicked": 900},
        {"Titles": "Viral Shorts", "ArabicTitle": "شورتس فيروسية", "Media Played": "75,000", "Likes": 2500, "Watched Clicked": 1500},
        {"Titles": "Titles", "ArabicTitle": "المزيد من الشورتس", "Media Played": "5,000", "Likes": 100, "Watched Clicked": 50},
        {"Titles": "Cool Vids", "ArabicTitle": "فيديوهات رائعة", "Media Played": "800", "Likes": 10, "Watched Clicked": 10},
        {"Titles": "Cool Vids", "ArabicTitle": "فيديو قصير", "Media Played": "1.2K", "Likes": 50, "Watched Clicked": 20}
    ];

    let allClipsData = [];
    let aggregatedData = [];
    let charts = {};
    let selectedTitles = [];
    const pageSize = 10;
    let currentPage = 1;

    document.addEventListener('DOMContentLoaded', () => {
        // Initial rendering with sample data
        updateDashboard(sampleData);

        // Event listeners
        document.getElementById('file-upload').addEventListener('change', handleFileUpload);
        document.getElementById('search-title').addEventListener('input', applyFilters);
        document.getElementById('min-views').addEventListener('input', applyFilters);
        document.getElementById('max-views').addEventListener('input', applyFilters);
        document.getElementById('min-avg-per-view').addEventListener('input', applyFilters);
        document.getElementById('sort-by').addEventListener('change', applyFilters);
        document.getElementById('top-n').addEventListener('input', applyFilters);
        document.getElementById('export-csv').addEventListener('click', exportTableToCsv);
        document.getElementById('export-png').addEventListener('click', exportChartsToPng);
        document.getElementById('profile-table').addEventListener('click', handleTableSortOrDrilldown);
        document.getElementById('comparison-select-box').addEventListener('click', toggleComparisonOptions);
        document.getElementById('comparison-options').addEventListener('change', handleComparisonSelect);

        document.querySelector('.close-button').addEventListener('click', () => {
            document.getElementById('drilldown-modal').style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('drilldown-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });

    /**
     * Helper function to safely parse a string or number value into a float.
     * It handles commas and common suffixes like K, M, and B.
     * @param {*} value The value to parse.
     * @returns {number} The parsed number, or 0 if parsing fails.
     */
    function cleanNumber(value) {
        if (typeof value === 'number') {
            return value;
        }
        if (typeof value !== 'string') {
            return 0;
        }

        let cleaned = value.replace(/,/g, '');
        let multiplier = 1;

        if (cleaned.toUpperCase().endsWith('K')) {
            multiplier = 1000;
            cleaned = cleaned.slice(0, -1);
        } else if (cleaned.toUpperCase().endsWith('M')) {
            multiplier = 1000000;
            cleaned = cleaned.slice(0, -1);
        } else if (cleaned.toUpperCase().endsWith('B')) {
            multiplier = 1000000000;
            cleaned = cleaned.slice(0, -1);
        }

        const parsed = parseFloat(cleaned);
        return isNaN(parsed) ? 0 : parsed * multiplier;
    }


    /**
     * Handles file upload and parses the Excel data.
     * @param {Event} event The file change event.
     */
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                let combinedData = [];
                
                // Read from Dovies and FCCE sheets
                const sheetNames = ["Dovies", "FCCE"];
                sheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    if (sheet) {
                        const json = XLSX.utils.sheet_to_json(sheet);
                        combinedData = combinedData.concat(json);
                    }
                });
                
                // Handle empty data case
                if (combinedData.length === 0) {
                     // Using a simple message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px;background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.5);z-index:9999;';
                    messageBox.textContent = "No data found in 'Dovies' or 'FCCE' sheets. Please check your Excel file.";
                    document.body.appendChild(messageBox);
                    setTimeout(() => messageBox.remove(), 2000);
                     return;
                }

                allClipsData = combinedData;
                updateDashboard(allClipsData);
            };
            reader.readAsArrayBuffer(file);
        } catch (error) {
            console.error('Error reading or parsing file:', error);
             // Using a simple message box instead of alert()
            const messageBox = document.createElement('div');
            messageBox.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px;background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.5);z-index:9999;';
            messageBox.textContent = 'Error processing file. Please ensure it is a valid .xlsx file.';
            document.body.appendChild(messageBox);
            setTimeout(() => messageBox.remove(), 2000);
        }
    }

    /**
     * Updates all components of the dashboard.
     * @param {Array<Object>} data The raw clips data.
     */
    function updateDashboard(data) {
        allClipsData = data;
        aggregatedData = groupByTitle(data);
        applyFilters();
        renderComparisonOptions();
    }

    /**
     * Groups clips data by title and computes aggregate metrics.
     * @param {Array<Object>} data The raw clips data.
     * @returns {Array<Object>} The aggregated titles data.
     */
    function groupByTitle(data) {
        const titlesMap = new Map();
        data.forEach(clip => {
            const titleName = clip.Titles || 'Unknown';
            if (!titlesMap.has(titleName)) {
                titlesMap.set(titleName, {
                    title: titleName,
                    clips: 0,
                    total_views: 0,
                    total_likes: 0,
                    total_watched_clicks: 0,
                    clips_list: []
                });
            }
            const title = titlesMap.get(titleName);
            title.clips += 1;
            title.total_views += cleanNumber(clip['Media Played']);
            title.total_likes += cleanNumber(clip['Likes']);
            title.total_watched_clicks += cleanNumber(clip['Watched Clicked']);
            title.clips_list.push(clip);
        });

        const aggregatedTitles = Array.from(titlesMap.values());
        aggregatedTitles.forEach(title => {
            title.avg_views_per_clip = (title.clips > 0) ? (title.total_views / title.clips) : 0;
            title.avg_per_view_conversion = (title.total_views > 0) ? (title.total_watched_clicks / title.total_views) : 0;
        });

        return aggregatedTitles;
    }

    /**
     * Applies filters, sorts, and renders the dashboard elements.
     */
    function applyFilters() {
        const searchTerm = document.getElementById('search-title').value.toLowerCase();
        const minViews = parseFloat(document.getElementById('min-views').value) || 0;
        const maxViews = parseFloat(document.getElementById('max-views').value) || Infinity;
        const minAvgPerView = parseFloat(document.getElementById('min-avg-per-view').value) || 0;
        const sortBy = document.getElementById('sort-by').value;
        const topN = parseInt(document.getElementById('top-n').value) || 10;

        let filteredData = aggregatedData.filter(title => {
            const titleName = title.title || '';
            const titleViews = title.total_views || 0;
            const titleAvg = title.avg_per_view_conversion || 0;
            return titleName.toLowerCase().includes(searchTerm) &&
                   titleViews >= minViews &&
                   titleViews <= maxViews &&
                   titleAvg >= minAvgPerView;
        });

        // Sort data
        filteredData.sort((a, b) => {
            if (sortBy === 'total_views') {
                return b.total_views - a.total_views;
            } else if (sortBy === 'avg_per_view_conversion') {
                return b.avg_per_view_conversion - a.avg_per_view_conversion;
            } else if (sortBy === 'avg_views_per_clip') {
                return b.avg_views_per_clip - a.avg_views_per_clip;
            } else if (sortBy === 'total_likes') {
                return b.total_likes - a.total_likes;
            } else if (sortBy === 'total_watched_clicks') {
                return b.total_watched_clicks - a.total_watched_clicks;
            }
        });

        const topNData = filteredData.slice(0, topN);

        renderKPIs();
        renderInsights(filteredData);
        renderCharts(topNData);
        renderTable(filteredData);
    }

    /**
     * Renders the key performance indicator (KPI) cards.
     */
    function renderKPIs() {
        const totalTitles = aggregatedData.length;
        const totalClips = allClipsData.length;
        const totalViews = aggregatedData.reduce((sum, p) => sum + p.total_views, 0);
        const totalClicks = aggregatedData.reduce((sum, p) => sum + p.total_watched_clicks, 0);
        const overallAvgPerViewConversion = (totalViews > 0) ? (totalClicks / totalViews) : 0;
        const overallAvgViewsPerClip = (totalClips > 0) ? (totalViews / totalClips) : 0;

        document.getElementById('kpi-titles').textContent = formatNumber(totalTitles);
        document.getElementById('kpi-clips').textContent = formatNumber(totalClips);
        document.getElementById('kpi-views').textContent = formatNumber(totalViews);
        document.getElementById('kpi-avg-views-per-clip').textContent = formatNumber(Math.round(overallAvgViewsPerClip));
        document.getElementById('kpi-avg-per-view-conversion').textContent = overallAvgPerViewConversion.toFixed(3);
    }
    
    /**
     * Renders the auto-generated insights as a bulleted list.
     * @param {Array<Object>} data The filtered and sorted data.
     */
    function renderInsights(data) {
        const insightsContainer = document.getElementById('insights-text');
        insightsContainer.innerHTML = ''; // Clear previous insights
        
        if (data.length === 0) {
            insightsContainer.innerHTML = `<p>Not enough data to generate insights.</p>`;
            return;
        }

        const sortedByViews = [...data].sort((a, b) => b.total_views - a.total_views);
        const sortedByAvgConversion = [...data].sort((a, b) => b.avg_per_view_conversion - a.avg_per_view_conversion);
        const sortedByLikes = [...data].sort((a, b) => b.total_likes - a.total_likes);

        const topViewsTitle = sortedByViews[0] ? `<b>${sortedByViews[0].title}</b> with ${formatNumber(sortedByViews[0].total_views)} views` : 'N/A';
        const topConversionTitle = sortedByAvgConversion[0] ? `<b>${sortedByAvgConversion[0].title}</b> with an average conversion of ${sortedByAvgConversion[0].avg_per_view_conversion.toFixed(3)}` : 'N/A';
        const topLikesTitle = sortedByLikes[0] ? `<b>${sortedByLikes[0].title}</b> with ${formatNumber(sortedByLikes[0].total_likes)} likes` : 'N/A';
        const lowestConversionTitles = sortedByAvgConversion.slice(-5).reverse().map(p => p.title).join(', ');

        const totalViews = sortedByViews.reduce((sum, p) => sum + p.total_views, 0);
        let cumulativeViews = 0;
        let topXCount = 0;
        for (const title of sortedByViews) {
            cumulativeViews += title.total_views;
            topXCount++;
            if (cumulativeViews / totalViews >= 0.8) {
                break;
            }
        }
        
        const insightsHtml = `
            <ul>
                <li>The most viewed title is ${topViewsTitle}.</li>
                <li>The title with the highest conversion rate (Watched Clicks per View) is ${topConversionTitle}.</li>
                <li>The most liked title is ${topLikesTitle}.</li>
                <li>Titles with the lowest conversion rates include: ${lowestConversionTitles}. Consider analyzing these to see why they don't engage viewers effectively.</li>
                <li>According to the 80/20 rule, approximately <b>${topXCount} titles</b>, or <b>${((topXCount / aggregatedData.length) * 100).toFixed(0)}%</b> of all titles, account for 80% of all total views.</li>
            </ul>
        `;
        
        insightsContainer.innerHTML = insightsHtml;
    }

    /**
     * Renders all charts using Chart.js.
     * @param {Array<Object>} data The filtered and sorted data for charts.
     */
    function renderCharts(data) {
        const labels = data.map(p => p.title);
        const views = data.map(p => p.total_views);
        const avgViewsPerClip = data.map(p => p.avg_views_per_clip);
        const clicks = data.map(p => p.total_watched_clicks);
        const likes = data.map(p => p.total_likes);

        // Bar Chart: Titles by Total Views
        if (charts.viewsChart) charts.viewsChart.destroy();
        const viewsCtx = document.getElementById('viewsChart').getContext('2d');
        charts.viewsChart = new Chart(viewsCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Views',
                    data: views,
                    backgroundColor: 'rgba(26, 35, 126, 0.7)',
                    borderColor: 'rgba(26, 35, 126, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y', // Set to horizontal
                plugins: { title: { display: true, text: `Top ${data.length} Titles by Total Views` } },
                scales: { x: { beginAtZero: true, title: { display: true, text: 'Total Views' }, ticks: { callback: formatNumber } }, y: { title: { display: true, text: 'Title' } } }
            }
        });

        // Bar Chart: Titles by Avg Views per Clip
        if (charts.avgPerViewChart) charts.avgPerViewChart.destroy();
        const avgsCtx = document.getElementById('avgPerViewChart').getContext('2d');
        charts.avgPerViewChart = new Chart(avgsCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Avg Views per Clip',
                    data: avgViewsPerClip,
                    backgroundColor: 'rgba(63, 81, 181, 0.7)',
                    borderColor: 'rgba(63, 81, 181, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y', // Set to horizontal
                plugins: { title: { display: true, text: `Top ${data.length} Titles by Avg Views per Clip` } },
                scales: { x: { beginAtZero: true, title: { display: true, text: 'Avg Views per Clip' } }, y: { title: { display: true, text: 'Title' } } }
            }
        });

        // Scatter Chart: Total Views vs. Total Watched Clicks
        if (charts.scatterChart) charts.scatterChart.destroy();
        const scatterCtx = document.getElementById('scatterChart').getContext('2d');
        const scatterData = data.map(p => ({
            x: p.total_views,
            y: p.total_watched_clicks,
            title: p.title,
            views: p.total_views,
            clicks: p.total_watched_clicks,
            likes: p.total_likes,
            avg: p.avg_per_view_conversion
        }));
        charts.scatterChart = new Chart(scatterCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Views vs. Watched Clicks',
                    data: scatterData,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    pointRadius: 6, pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Total Views vs. Total Watched Clicks' },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const p = context.raw;
                                return [`Title: ${p.title}`, `Views: ${formatNumber(p.views)}`, `Clicks: ${formatNumber(p.clicks)}`, `Likes: ${formatNumber(p.likes)}`, `Avg/View: ${p.avg.toFixed(3)}`];
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Total Views' }, ticks: { callback: formatNumber } },
                    y: { title: { display: true, text: 'Total Watched Clicks' }, ticks: { callback: formatNumber } }
                }
            }
        });

        // Stacked Bar Chart: Likes vs Watched Clicks
        if (charts.stackedBarChart) charts.stackedBarChart.destroy();
        const stackedCtx = document.getElementById('stackedBarChart').getContext('2d');
        const top10Titles = data.slice(0, 10);
        charts.stackedBarChart = new Chart(stackedCtx, {
            type: 'bar',
            data: {
                labels: top10Titles.map(t => t.title),
                datasets: [
                    {
                        label: 'Likes',
                        data: top10Titles.map(t => t.total_likes),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        stack: 'metrics'
                    },
                    {
                        label: 'Watched Clicks',
                        data: top10Titles.map(t => t.total_watched_clicks),
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        stack: 'metrics'
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { title: { display: true, text: 'Likes vs. Watched Clicks (Top 10 Titles)' } },
                scales: {
                    x: { stacked: true, title: { display: true, text: 'Title' } },
                    y: { stacked: true, title: { display: true, text: 'Count' }, ticks: { callback: formatNumber } }
                }
            }
        });
    }

    /**
     * Renders the main profiles table.
     * @param {Array<Object>} data The filtered and sorted data for the table.
     */
    function renderTable(data) {
        const tableBody = document.getElementById('table-body');
        tableBody.innerHTML = ''; // Clear existing rows
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = data.slice(start, end);

        pageData.forEach(title => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><a href="#" class="drilldown-link" data-title="${title.title}">${title.title}</a></td>
                <td>${formatNumber(title.clips)}</td>
                <td>${formatNumber(title.total_views)}</td>
                <td>${formatNumber(title.total_likes)}</td>
                <td>${formatNumber(title.total_watched_clicks)}</td>
                <td>${formatNumber(Math.round(title.avg_views_per_clip))}</td>
                <td>${title.avg_per_view_conversion.toFixed(3)}</td>
            `;
            tableBody.appendChild(row);
        });

        // Render pagination controls
        const totalPages = Math.ceil(data.length / pageSize);
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';
        if (totalPages > 1) {
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === currentPage ? 'active' : '';
                button.onclick = () => {
                    currentPage = i;
                    renderTable(data);
                };
                paginationControls.appendChild(button);
            }
        }
    }

    /**
     * Handles table header sorting and row drilldown.
     * @param {Event} event The click event on the table.
     */
    function handleTableSortOrDrilldown(event) {
        const target = event.target;
        if (target.tagName === 'TH') {
            const column = target.getAttribute('data-column');
            if (column) {
                const currentSort = target.classList.contains('asc') ? 'asc' : target.classList.contains('desc') ? 'desc' : '';
                
                // Clear all sort classes
                document.querySelectorAll('#profile-table th').forEach(th => th.classList.remove('asc', 'desc'));
                
                let sortDirection = 'asc';
                if (currentSort === 'asc') {
                    sortDirection = 'desc';
                    target.classList.add('desc');
                } else {
                    target.classList.add('asc');
                }
                
                const sortedData = [...aggregatedData].sort((a, b) => {
                    const aVal = a[column];
                    const bVal = b[column];
                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                
                aggregatedData = sortedData;
                applyFilters();
            }
        } else if (target.classList.contains('drilldown-link')) {
            event.preventDefault();
            const titleName = target.getAttribute('data-title');
            showDrilldown(titleName);
        }
    }

    /**
     * Displays a modal with detailed clips for a given title.
     * @param {string} titleName The name of the title to show details for.
     */
    function showDrilldown(titleName) {
        const titleData = aggregatedData.find(t => t.title === titleName);
        if (!titleData) return;

        document.getElementById('drilldown-profile-title').textContent = `Details for ${titleName}`;
        const drilldownTableBody = document.getElementById('drilldown-table-body');
        drilldownTableBody.innerHTML = '';

        titleData.clips_list.forEach(clip => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${clip.ArabicTitle || 'N/A'}</td>
                <td>${formatNumber(cleanNumber(clip['Media Played']))}</td>
                <td>${formatNumber(cleanNumber(clip['Likes']))}</td>
                <td>${formatNumber(cleanNumber(clip['Watched Clicked']))}</td>
            `;
            drilldownTableBody.appendChild(row);
        });

        document.getElementById('drilldown-modal').style.display = 'flex';
    }

    /**
     * Toggles the visibility of the comparison multi-select options.
     */
    function toggleComparisonOptions() {
        const optionsContainer = document.getElementById('comparison-options');
        optionsContainer.style.display = optionsContainer.style.display === 'block' ? 'none' : 'block';
    }

    /**
     * Renders the options for the title comparison multi-select.
     */
    function renderComparisonOptions() {
        const optionsContainer = document.getElementById('comparison-options');
        optionsContainer.innerHTML = '';
        aggregatedData.forEach(title => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${title.title}"> ${title.title}`;
            optionsContainer.appendChild(label);
        });
        document.getElementById('comparison-panel').style.display = 'none';
        selectedTitles = [];
        document.getElementById('comparison-select-box').querySelector('span').textContent = 'Compare Titles';
    }

    /**
     * Handles the change event for the comparison multi-select checkboxes.
     */
    function handleComparisonSelect(event) {
        selectedTitles = Array.from(document.querySelectorAll('#comparison-options input[type="checkbox"]:checked')).map(cb => cb.value);
        
        const selectBoxSpan = document.getElementById('comparison-select-box').querySelector('span');
        if (selectedTitles.length > 0) {
            selectBoxSpan.textContent = `Comparing (${selectedTitles.length})`;
            renderComparisonPanel();
        } else {
            selectBoxSpan.textContent = 'Compare Titles';
            document.getElementById('comparison-panel').style.display = 'none';
        }
    }

    /**
     * Renders the comparison panel with selected titles.
     */
    function renderComparisonPanel() {
        const comparisonCardsContainer = document.getElementById('comparison-cards');
        comparisonCardsContainer.innerHTML = '';

        if (selectedTitles.length === 0) {
            document.getElementById('comparison-panel').style.display = 'none';
            return;
        }

        document.getElementById('comparison-panel').style.display = 'block';

        const selectedData = selectedTitles.map(title => aggregatedData.find(d => d.title === title)).filter(Boolean);
        if (selectedData.length === 0) {
            document.getElementById('comparison-panel').style.display = 'none';
            return;
        }

        // Find the best values for each metric for better comparison
        const maxViews = Math.max(...selectedData.map(d => d.total_views));
        const maxLikes = Math.max(...selectedData.map(d => d.total_likes));
        const maxClicks = Math.max(...selectedData.map(d => d.total_watched_clicks));
        const maxAvgViews = Math.max(...selectedData.map(d => d.avg_views_per_clip));
        const maxAvgConversion = Math.max(...selectedData.map(d => d.avg_per_view_conversion));

        selectedData.forEach(title => {
            const card = document.createElement('div');
            card.className = 'comparison-card';
            card.innerHTML = `
                <h4>${title.title}</h4>
                <div class="comparison-metric">
                    <span>Total Views:</span>
                    <span class="${title.total_views === maxViews ? 'better-metric' : ''}">${formatNumber(title.total_views)}</span>
                </div>
                <div class="comparison-metric">
                    <span>Total Likes:</span>
                    <span class="${title.total_likes === maxLikes ? 'better-metric' : ''}">${formatNumber(title.total_likes)}</span>
                </div>
                <div class="comparison-metric">
                    <span>Total Watched Clicks:</span>
                    <span class="${title.total_watched_clicks === maxClicks ? 'better-metric' : ''}">${formatNumber(title.total_watched_clicks)}</span>
                </div>
                <div class="comparison-metric">
                    <span>Avg Views/Clip:</span>
                    <span class="${title.avg_views_per_clip === maxAvgViews ? 'better-metric' : ''}">${formatNumber(Math.round(title.avg_views_per_clip))}</span>
                </div>
                <div class="comparison-metric">
                    <span>Avg/View Conversion:</span>
                    <span class="${title.avg_per_view_conversion === maxAvgConversion ? 'better-metric' : ''}">${title.avg_per_view_conversion.toFixed(3)}</span>
                </div>
            `;
            comparisonCardsContainer.appendChild(card);
        });
    }

    /**
     * Formats a number for better readability (e.g., 1234567 -> 1.23M).
     * @param {number} num The number to format.
     * @returns {string} The formatted string.
     */
    function formatNumber(num) {
        if (num === null || num === undefined) return '0';
        num = Number(num);
        if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    /**
     * Exports the visible table data to a CSV file.
     */
    function exportTableToCsv() {
        const table = document.getElementById('profile-table');
        let csv = [];
        const rows = table.querySelectorAll('tr');

        rows.forEach(row => {
            const rowData = Array.from(row.querySelectorAll('th, td')).map(cell => {
                let text = cell.innerText;
                // Clean up text from drilldown link
                if (cell.querySelector('.drilldown-link')) {
                    text = cell.querySelector('.drilldown-link').textContent;
                }
                return `"${text.replace(/"/g, '""')}"`;
            });
            csv.push(rowData.join(','));
        });

        const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "shorts_performance_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    /**
     * Exports all charts to a single PNG file.
     */
    async function exportChartsToPng() {
        const dashboard = document.querySelector('.dashboard-container');
        const originalBg = dashboard.style.backgroundColor;
        dashboard.style.backgroundColor = 'white'; // Make background white for better PNG output
        const chartsToExport = document.querySelectorAll('.chart-box canvas');
        const chartImages = await Promise.all(Array.from(chartsToExport).map(canvas => {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = canvas.toDataURL('image/png');
            });
        }));

        const combinedCanvas = document.createElement('canvas');
        const combinedCtx = combinedCanvas.getContext('2d');
        const padding = 20;
        const totalHeight = chartImages.reduce((sum, img) => sum + img.height + padding, 0);
        const maxWidth = Math.max(...chartImages.map(img => img.width));

        combinedCanvas.width = maxWidth + padding * 2;
        combinedCanvas.height = totalHeight;
        combinedCtx.fillStyle = 'white';
        combinedCtx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);

        let yOffset = padding;
        chartImages.forEach(img => {
            combinedCtx.drawImage(img, padding, yOffset);
            yOffset += img.height + padding;
        });

        const link = document.createElement('a');
        link.href = combinedCanvas.toDataURL('image/png');
        link.download = 'shorts_performance_charts.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        dashboard.style.backgroundColor = originalBg; // Restore original background
    }

</script>
</body>
</html>
