<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro-Drama App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #262626;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .loading-spinner {
            border-top-color: #f87171;
            -webkit-animation: spinner-border 0.75s linear infinite;
            animation: spinner-border 0.75s linear infinite;
        }
        @-webkit-keyframes spinner-border {
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-zinc-950 text-white min-h-screen">
    <div id="root"></div>

    <script type="module">
        // Helper function to convert base64 to ArrayBuffer (for potential audio use)
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        // Helper function to convert PCM audio data to WAV blob (for potential audio use)
        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const sampleRateValue = sampleRate;
            const bitsPerSample = 16;
            const byteRate = (sampleRateValue * numChannels * bitsPerSample) / 8;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const dataSize = pcmData.length * 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            let offset = 0;

            // RIFF header
            view.setUint32(offset, 0x52494646, false); // "RIFF"
            offset += 4;
            view.setUint32(offset, 36 + dataSize, true); // file size
            offset += 4;
            view.setUint32(offset, 0x57415645, false); // "WAVE"
            offset += 4;

            // fmt sub-chunk
            view.setUint32(offset, 0x666d7420, false); // "fmt "
            offset += 4;
            view.setUint32(offset, 16, true); // sub-chunk size
            offset += 4;
            view.setUint16(offset, 1, true); // audio format (PCM)
            offset += 2;
            view.setUint16(offset, numChannels, true); // number of channels
            offset += 2;
            view.setUint32(offset, sampleRateValue, true); // sample rate
            offset += 4;
            view.setUint32(offset, byteRate, true); // byte rate
            offset += 4;
            view.setUint16(offset, blockAlign, true); // block align
            offset += 2;
            view.setUint16(offset, bitsPerSample, true); // bits per sample
            offset += 2;

            // data sub-chunk
            view.setUint32(offset, 0x64617461, false); // "data"
            offset += 4;
            view.setUint32(offset, dataSize, true); // data size
            offset += 4;

            // write PCM data
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        };

        // --- MOCK DATA AND STATE MANAGEMENT ---
        const seriesData = [
            {
                id: 'series-1',
                title: 'Echoes of the Void',
                genre: 'Sci-Fi, Drama',
                totalShorts: 15,
                shorts: Array.from({ length: 15 }, (_, i) => ({
                    id: `short-1-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 60,
                    likes: Math.floor(Math.random() * 1000),
                    comments: Math.floor(Math.random() * 50),
                    shares: Math.floor(Math.random() * 20),
                })),
            },
            {
                id: 'series-2',
                title: 'The Unspoken Promise',
                genre: 'Romance, Mystery',
                totalShorts: 12,
                shorts: Array.from({ length: 12 }, (_, i) => ({
                    id: `short-2-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 45,
                    likes: Math.floor(Math.random() * 1200),
                    comments: Math.floor(Math.random() * 75),
                    shares: Math.floor(Math.random() * 30),
                })),
            },
            {
                id: 'series-3',
                title: 'City of Whispers',
                genre: 'Thriller, Crime',
                totalShorts: 18,
                shorts: Array.from({ length: 18 }, (_, i) => ({
                    id: `short-3-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 90,
                    likes: Math.floor(Math.random() * 800),
                    comments: Math.floor(Math.random() * 40),
                    shares: Math.floor(Math.random() * 15),
                })),
            },
            {
                id: 'series-4',
                title: 'The Final Descent',
                genre: 'Adventure, Thriller',
                totalShorts: 14,
                shorts: Array.from({ length: 14 }, (_, i) => ({
                    id: `short-4-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 75,
                    likes: Math.floor(Math.random() * 1500),
                    comments: Math.floor(Math.random() * 90),
                    shares: Math.floor(Math.random() * 45),
                })),
            },
            {
                id: 'series-5',
                title: 'The Last Whisper',
                genre: 'Psychological Thriller, Mystery',
                totalShorts: 16,
                shorts: Array.from({ length: 16 }, (_, i) => ({
                    id: `short-5-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 80,
                    likes: Math.floor(Math.random() * 1100),
                    comments: Math.floor(Math.random() * 60),
                    shares: Math.floor(Math.random() * 25),
                })),
            },
            {
                id: 'series-6',
                title: 'Dust and Echoes',
                genre: 'Post-Apocalyptic, Drama',
                totalShorts: 20,
                shorts: Array.from({ length: 20 }, (_, i) => ({
                    id: `short-6-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 65,
                    likes: Math.floor(Math.random() * 950),
                    comments: Math.floor(Math.random() * 55),
                    shares: Math.floor(Math.random() * 35),
                })),
            },
            {
                id: 'series-7',
                title: 'Aetherium\'s Call',
                genre: 'Fantasy, Adventure',
                totalShorts: 17,
                shorts: Array.from({ length: 17 }, (_, i) => ({
                    id: `short-7-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 50,
                    likes: Math.floor(Math.random() * 1300),
                    comments: Math.floor(Math.random() * 85),
                    shares: Math.floor(Math.random() * 40),
                })),
            },
            {
                id: 'series-8',
                title: 'Crimson Silk',
                genre: 'Historical, Romance',
                totalShorts: 13,
                shorts: Array.from({ length: 13 }, (_, i) => ({
                    id: `short-8-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 55,
                    likes: Math.floor(Math.random() * 1400),
                    comments: Math.floor(Math.random() * 95),
                    shares: Math.floor(Math.random() * 50),
                })),
            },
            {
                id: 'series-9',
                title: 'The Chronos Gambit',
                genre: 'Time Travel, Sci-Fi',
                totalShorts: 18,
                shorts: Array.from({ length: 18 }, (_, i) => ({
                    id: `short-9-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 70,
                    likes: Math.floor(Math.random() * 1600),
                    comments: Math.floor(Math.random() * 110),
                    shares: Math.floor(Math.random() * 60),
                })),
            },
            {
                id: 'series-10',
                title: 'Beneath the Surface',
                genre: 'Environmental, Drama',
                totalShorts: 14,
                shorts: Array.from({ length: 14 }, (_, i) => ({
                    id: `short-10-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 85,
                    likes: Math.floor(Math.random() * 900),
                    comments: Math.floor(Math.random() * 50),
                    shares: Math.floor(Math.random() * 20),
                })),
            },
            {
                id: 'series-11',
                title: 'The Starlight Heist',
                genre: 'Crime, Fantasy',
                totalShorts: 16,
                shorts: Array.from({ length: 16 }, (_, i) => ({
                    id: `short-11-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 60,
                    likes: Math.floor(Math.random() * 1500),
                    comments: Math.floor(Math.random() * 80),
                    shares: Math.floor(Math.random() * 35),
                })),
            },
            {
                id: 'series-12',
                title: 'Whispers of the Past',
                genre: 'Historical, Paranormal',
                totalShorts: 19,
                shorts: Array.from({ length: 19 }, (_, i) => ({
                    id: `short-12-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 75,
                    likes: Math.floor(Math.random() * 1100),
                    comments: Math.floor(Math.random() * 70),
                    shares: Math.floor(Math.random() * 40),
                })),
            },
            {
                id: 'series-13',
                title: 'Neon Serenade',
                genre: 'Cyberpunk, Romance',
                totalShorts: 15,
                shorts: Array.from({ length: 15 }, (_, i) => ({
                    id: `short-13-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 55,
                    likes: Math.floor(Math.random() * 1800),
                    comments: Math.floor(Math.random() * 100),
                    shares: Math.floor(Math.random() * 50),
                })),
            },
            {
                id: 'series-14',
                title: 'The Silent Witness',
                genre: 'Legal, Thriller',
                totalShorts: 17,
                shorts: Array.from({ length: 17 }, (_, i) => ({
                    id: `short-14-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 65,
                    likes: Math.floor(Math.random() * 1300),
                    comments: Math.floor(Math.random() * 75),
                    shares: Math.floor(Math.random() * 30),
                })),
            },
            {
                id: 'series-15',
                title: 'Lost in the Aurora',
                genre: 'Survival, Adventure',
                totalShorts: 20,
                shorts: Array.from({ length: 20 }, (_, i) => ({
                    id: `short-15-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 90,
                    likes: Math.floor(Math.random() * 1000),
                    comments: Math.floor(Math.random() * 60),
                    shares: Math.floor(Math.random() * 25),
                })),
            },
            {
                id: 'series-16',
                title: 'Glass House Secrets',
                genre: 'Family Drama, Mystery',
                totalShorts: 14,
                shorts: Array.from({ length: 14 }, (_, i) => ({
                    id: `short-16-${i}`,
                    videoUrl: 'http://commondatestorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    duration: 80,
                    likes: Math.floor(Math.random() * 1200),
                    comments: Math.floor(Math.random() * 90),
                    shares: Math.floor(Math.random() * 45),
                })),
            },
        ];

        let state = {
            view: 'series', // 'series', 'shortsList', or 'shortsViewer'
            activeSeries: null,
            activeShortIndex: 0,
            lastWatched: null,
            unlockedShorts: new Set(),
            posters: {},
            isLoadingPosters: true,
            showCommentModal: false,
            commentText: '',
            aiAnalysis: null,
            isAnalyzing: false,
        };

        const updateState = (newState) => {
            state = { ...state, ...newState };
            render();
        };

        const getLastWatched = () => {
            try {
                const lastWatched = localStorage.getItem('lastWatched');
                return lastWatched ? JSON.parse(lastWatched) : null;
            } catch (e) {
                console.error('Failed to get last watched from localStorage', e);
                return null;
            }
        };

        const setLastWatched = (seriesId, shortIndex) => {
            try {
                localStorage.setItem('lastWatched', JSON.stringify({ seriesId, shortIndex }));
            } catch (e) {
                console.error('Failed to set last watched in localStorage', e);
            }
        };

        const getUnlockedShortsFromLocalStorage = (seriesId) => {
            try {
                const unlocked = localStorage.getItem(`unlocked-${seriesId}`);
                return unlocked ? new Set(JSON.parse(unlocked)) : new Set([0]);
            } catch (e) {
                console.error('Failed to get unlocked shorts from localStorage', e);
                return new Set([0]);
            }
        };

        const setUnlockedShortsInLocalStorage = (seriesId, unlockedShorts) => {
            try {
                localStorage.setItem(`unlocked-${seriesId}`, JSON.stringify(Array.from(unlockedShorts)));
            } catch (e) {
                console.error('Failed to set unlocked shorts in localStorage', e);
            }
        };

        // --- API & DATA FETCHING ---
        const generatePosters = async () => {
            const generatedPosters = {};
            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict";

            const promises = seriesData.map(async (series) => {
                const prompt = `A dramatic movie poster for a micro-drama series titled "${series.title}" in the genre of ${series.genre}. High-quality, cinematic style, vertical format.`;
                const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };

                let retryCount = 0;
                const maxRetries = 3;
                const initialDelay = 1000;

                const makeApiCall = async () => {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                            generatedPosters[series.id] = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        } else {
                            throw new Error("Image generation failed.");
                        }
                    } catch (e) {
                        console.error(`API call failed for ${series.title}:`, e);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            const delay = initialDelay * Math.pow(2, retryCount);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return makeApiCall();
                        } else {
                            console.error(`Failed to generate image for ${series.title} after multiple retries.`);
                            generatedPosters[series.id] = `https://placehold.co/600x800/27272a/fafafa?text=${encodeURIComponent(series.title)}`;
                        }
                    }
                };
                return makeApiCall();
            });

            await Promise.all(promises);
            updateState({ posters: generatedPosters, isLoadingPosters: false });
        };

        // --- EVENT HANDLERS ---
        const handleSelectSeries = (seriesId, initialShortIndex = 0) => {
            const selectedSeries = seriesData.find(s => s.id === seriesId);
            const unlocked = getUnlockedShortsFromLocalStorage(seriesId);
            updateState({
                activeSeries: selectedSeries,
                unlockedShorts: unlocked,
                activeShortIndex: initialShortIndex,
                view: 'shortsList'
            });
        };

        const handleSelectShort = (shortIndex) => {
            updateState({ activeShortIndex: shortIndex, view: 'shortsViewer' });
        };

        const handleUnlockNextShort = (completedIndex) => {
            if (state.activeSeries) {
                const nextIndex = completedIndex + 1;
                const newUnlockedShorts = new Set(state.unlockedShorts);
                if (nextIndex < state.activeSeries.totalShorts && !newUnlockedShorts.has(nextIndex)) {
                    newUnlockedShorts.add(nextIndex);
                    updateState({ unlockedShorts: newUnlockedShorts });
                    setUnlockedShortsInLocalStorage(state.activeSeries.id, newUnlockedShorts);
                }
            }
        };

        const handleExitViewer = () => {
            updateState({ view: 'shortsList', lastWatched: getLastWatched() });
        };

        const handleBackFromList = () => {
            updateState({ view: 'series', activeSeries: null, lastWatched: getLastWatched() });
        };

        const togglePlayback = (videoElement) => {
            if (videoElement) {
                if (videoElement.paused) {
                    videoElement.play();
                } else {
                    videoElement.pause();
                }
            }
        };

        const handleAnalyzeComment = async () => {
            if (!state.commentText.trim()) return;

            updateState({ isAnalyzing: true, aiAnalysis: null });
            const userQuery = `Analyze the sentiment of the following comment: "${state.commentText}". Provide a simple, one-sentence summary of the tone (e.g., "This is a positive comment.", "This comment expresses frustration." or "This is a neutral comment.").`;
            const systemPrompt = "You are a professional sentiment analysis AI. Your task is to analyze user comments and provide a concise, single-sentence summary of the tone.";

            const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Could not analyze comment.";
                updateState({ aiAnalysis: text, isAnalyzing: false });
            } catch (error) {
                console.error('Error analyzing comment:', error);
                updateState({ aiAnalysis: "Analysis failed. Please try again.", isAnalyzing: false });
            }
        };

        // --- COMPONENT RENDERING FUNCTIONS ---
        const renderLoading = () => {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen bg-zinc-950 text-white">
                    <div class="h-12 w-12 rounded-full border-4 border-gray-700 loading-spinner"></div>
                    <p class="mt-4 text-sm text-zinc-400">Loading series posters...</p>
                </div>
            `;
        };

        const renderSeriesOverview = () => {
            const { lastWatched, posters, isLoadingPosters } = state;
            return `
                <div class="w-full min-h-screen p-4 sm:p-8 bg-zinc-950 text-white font-sans flex flex-col items-center">
                    <header class="w-full max-w-5xl py-6 flex flex-col items-center">
                        <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-center">
                            Sequential Micro-Dramas
                        </h1>
                        <p class="text-center text-zinc-400 mt-2 text-sm sm:text-base">
                            Vertically-shot short episodes. Bingeable stories.
                        </p>
                    </header>
                    
                    ${lastWatched ? `
                        <div class="w-full max-w-5xl mb-8">
                            <h2 class="text-xl sm:text-2xl font-semibold mb-4">
                                <span class="text-pink-500">Continue Watching</span>
                            </h2>
                            <div
                                class="w-full bg-zinc-800 p-4 rounded-xl flex flex-col sm:flex-row items-center cursor-pointer transition-transform duration-300 hover:scale-[1.01]"
                                onclick="handleSelectSeries('${lastWatched.seriesId}', ${lastWatched.shortIndex})"
                            >
                                ${isLoadingPosters ? `
                                    <div class="w-20 h-24 rounded-lg bg-zinc-700 animate-pulse flex items-center justify-center mr-4 mb-4 sm:mb-0">
                                        <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                ` : `
                                    <img src="${posters[lastWatched.seriesId]}" alt="Last watched series poster" class="w-20 h-24 rounded-lg object-cover mr-4 mb-4 sm:mb-0" />
                                `}
                                <div class="flex-1 text-center sm:text-left">
                                    <h3 class="text-lg font-semibold">${seriesData.find(s => s.id === lastWatched.seriesId)?.title}</h3>
                                    <p class="text-sm text-zinc-400 mt-1">
                                        Episode ${lastWatched.shortIndex + 1} of ${seriesData.find(s => s.id === lastWatched.seriesId)?.totalShorts}
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="w-full max-w-5xl">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4">
                            All Series
                        </h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 sm:gap-6">
                            ${seriesData.map(series => `
                                <div class="group rounded-xl overflow-hidden shadow-lg transition-transform duration-300 hover:scale-[1.03] active:scale-95 bg-zinc-800">
                                    <div class="w-full h-auto bg-zinc-800 aspect-[9/16] relative flex items-center justify-center">
                                        ${isLoadingPosters ? `
                                            <div class="absolute inset-0 flex items-center justify-center bg-zinc-700 animate-pulse">
                                                <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            </div>
                                        ` : `
                                            <img src="${state.posters[series.id]}" alt="${series.title}" class="w-full h-full object-cover transition-opacity duration-300 group-hover:opacity-85 cursor-pointer" onclick="handleSelectSeries('${series.id}')" />
                                        `}
                                    </div>
                                    <div class="p-3 text-center">
                                        <h3 class="text-sm sm:text-base font-semibold truncate">${series.title}</h3>
                                        <p class="text-xs text-zinc-400 mt-1">${series.genre}</p>
                                        <p class="text-xs text-zinc-500 mt-1 mb-2">
                                            ${series.totalShorts} parts
                                        </p>
                                        <div class="flex justify-center space-x-2">
                                            <button
                                                onclick="handleSelectSeries('${series.id}')"
                                                class="flex-1 px-2 py-1 text-xs font-semibold rounded-full bg-pink-500 text-white hover:bg-pink-600 transition-colors"
                                            >
                                                View Series
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderShortsList = () => {
            const { activeSeries, unlockedShorts, posters, isLoadingPosters } = state;
            if (!activeSeries) return '';

            return `
                <div class="w-full min-h-screen p-4 sm:p-8 bg-zinc-950 text-white font-sans flex flex-col items-center">
                    <header class="w-full max-w-5xl py-6 flex items-center justify-between">
                        <button onclick="handleBackFromList()" class="p-2 rounded-full bg-zinc-800 bg-opacity-70 backdrop-blur-sm transition-all hover:bg-opacity-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h1 class="text-xl sm:text-2xl font-bold tracking-tight text-center flex-1">${activeSeries.title}</h1>
                    </header>

                    <div class="w-full max-w-5xl grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 mt-4">
                        ${activeSeries.shorts.map((short, index) => {
                            const isUnlocked = unlockedShorts.has(index);
                            const isLastWatched = getLastWatched() && getLastWatched().seriesId === activeSeries.id && getLastWatched().shortIndex === index;
                            const isComingSoon = index === activeSeries.totalShorts - 1 && !isUnlocked;
                            const cursorClass = isUnlocked ? 'cursor-pointer' : 'cursor-not-allowed';
                            const opacityClass = isUnlocked ? '' : 'opacity-50';

                            return `
                                <div
                                    class="relative group rounded-xl overflow-hidden shadow-lg transition-transform duration-300 transform-gpu ${isUnlocked ? 'hover:scale-[1.03] active:scale-95' : ''} ${cursorClass}"
                                    onclick="${isUnlocked ? `handleSelectShort(${index})` : ''}"
                                >
                                    <div class="w-full h-auto bg-zinc-800 aspect-[9/16] relative flex items-center justify-center">
                                        ${isLoadingPosters ? `
                                            <div class="absolute inset-0 flex items-center justify-center bg-zinc-700 animate-pulse">
                                                <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            </div>
                                        ` : `
                                            <img src="${state.posters[activeSeries.id]}" alt="Poster for ${activeSeries.title}" class="w-full h-full object-cover transition-opacity duration-300 group-hover:opacity-85 ${opacityClass}" />
                                        `}
                                        ${!isUnlocked ? `
                                            <div class="absolute inset-0 flex items-center justify-center bg-zinc-900 bg-opacity-70">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 11.5V11a3 3 0 016 0v.5m-6 0h6m-6 0H5" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 11V7a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2h2z" />
                                                </svg>
                                            </div>
                                        ` : ''}
                                        ${isLastWatched && isUnlocked ? `
                                            <div class="absolute bottom-2 left-2 px-2 py-1 bg-pink-500 rounded-full text-xs font-semibold">
                                                Last Watched
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="p-3 text-center">
                                        <h3 class="text-sm sm:text-base font-semibold truncate text-white">
                                            Part ${index + 1}
                                        </h3>
                                        <p class="text-xs text-zinc-400 mt-1">
                                            ${short.duration}s
                                        </p>
                                        <div class="mt-2 text-xs font-medium">
                                            ${isComingSoon ? `
                                                <span class="text-zinc-500">
                                                    Coming Soon
                                                </span>
                                            ` : isUnlocked ? `
                                                <span class="text-green-400">
                                                    Unlocked
                                                </span>
                                            ` : `
                                                <span class="text-red-400">
                                                    Locked
                                                </span>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        const renderShortsViewer = () => {
            const { activeSeries, activeShortIndex, showCommentModal, commentText, aiAnalysis, isAnalyzing } = state;
            if (!activeSeries) return '';

            const activeShort = activeSeries.shorts[activeShortIndex];
            const isLastShort = activeShortIndex === activeSeries.shorts.length - 1;

            return `
                <div id="viewer" class="relative w-full h-screen flex flex-col justify-between items-center text-white bg-zinc-900 overflow-hidden">
                    <!-- Short's video element -->
                    <video
                        id="short-video"
                        class="absolute inset-0 z-0 w-full h-full object-cover"
                        src="${activeShort.videoUrl}"
                        autoplay
                        loop
                        muted
                        playsinline
                    ></video>

                    <!-- UI Overlay -->
                    <div class="relative z-10 w-full h-full flex flex-col justify-between items-center p-4">
                        <!-- Top Controls -->
                        <div class="w-full flex justify-between items-center">
                            <button onclick="handleExitViewer()" class="p-2 rounded-full bg-zinc-800 bg-opacity-70 backdrop-blur-sm transition-all hover:bg-opacity-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div class="text-sm font-semibold text-zinc-300">
                                ${activeShortIndex + 1} / ${activeSeries.shorts.length}
                            </div>
                        </div>
                        
                        <!-- Playback Controls -->
                        <div class="flex-1 flex items-center justify-center">
                            <button onclick="togglePlayback(document.getElementById('short-video'))" class="p-4 rounded-full bg-zinc-800 bg-opacity-70 backdrop-blur-sm transition-all hover:scale-110 active:scale-95">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.192 1.447h13.6a1 1 0 001.192-1.447l-7-14z" />
                                </svg>
                            </button>
                        </div>

                        <!-- Engagement Buttons -->
                        <div class="w-full flex justify-around items-center space-x-4">
                            <div class="flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white transition-transform hover:scale-125" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                                <span class="text-xs font-semibold mt-1">${activeShort.likes}</span>
                            </div>
                            <button onclick="updateState({ showCommentModal: true, aiAnalysis: null, commentText: '' })" class="flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white transition-transform hover:scale-125" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                                <span class="text-xs font-semibold mt-1">${activeShort.comments}</span>
                            </button>
                            <div class="flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white transition-transform hover:scale-125" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.882 13.486 9 13.714 9 14v1.298a2 2 0 00.325 1.135l2.427 3.235a1 1 0 001.597 0l2.427-3.235A2 2 0 0016 15.298V14c0-.286.118-.514.316-.658l2.91-2.289A2 2 0 0022 9.074V7h-4a2 2 0 00-2-2v-2a1 1 0 00-1-1H7a1 1 0 00-1 1v2a2 2 0 00-2 2H2v2.074a2 2 0 00.774 1.579l2.91 2.289z" />
                                </svg>
                                <span class="text-xs font-semibold mt-1">${activeShort.shares}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comment Modal -->
                    ${showCommentModal ? `
                        <div class="fixed inset-0 z-20 flex items-center justify-center bg-zinc-950 bg-opacity-90 p-4">
                            <div class="w-full max-w-lg bg-zinc-800 rounded-lg p-6 shadow-xl relative">
                                <h3 class="text-xl font-semibold mb-4 text-white">Add a Comment</h3>
                                <textarea
                                    id="comment-textarea"
                                    class="w-full bg-zinc-700 text-white rounded-lg p-3 resize-none focus:outline-none focus:ring-2 focus:ring-pink-500 transition-all"
                                    rows="4"
                                    placeholder="Type your comment here..."
                                >${commentText}</textarea>
                                <div class="mt-4 flex flex-col items-end">
                                    <button
                                        onclick="handleAnalyzeComment()"
                                        class="w-full px-4 py-2 text-sm font-bold rounded-full transition-colors ${isAnalyzing ? 'bg-zinc-600 text-zinc-400 cursor-not-allowed' : 'bg-pink-500 text-white hover:bg-pink-600'}"
                                        ${isAnalyzing ? 'disabled' : ''}
                                    >
                                        ${isAnalyzing ? '✨Analyzing...' : '✨Analyze Comment✨'}
                                    </button>
                                    ${aiAnalysis ? `
                                        <div class="mt-4 p-3 bg-zinc-700 rounded-lg w-full text-zinc-300">
                                            <h4 class="font-semibold text-xs text-zinc-400 mb-1">AI Analysis:</h4>
                                            <p class="text-sm">${aiAnalysis}</p>
                                        </div>
                                    ` : ''}
                                    <button
                                        onclick="updateState({ showCommentModal: false })"
                                        class="mt-4 px-4 py-2 text-sm text-zinc-400 font-semibold hover:text-white"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        const render = () => {
            const root = document.getElementById('root');
            if (state.isLoadingPosters) {
                root.innerHTML = renderLoading();
            } else if (state.view === 'shortsViewer') {
                root.innerHTML = renderShortsViewer();
            } else if (state.view === 'shortsList') {
                root.innerHTML = renderShortsList();
            } else {
                root.innerHTML = renderSeriesOverview();
            }

            // Re-attach event listeners and video-specific logic after render
            if (state.view === 'shortsViewer') {
                const videoElement = document.getElementById('short-video');
                const viewerElement = document.getElementById('viewer');
                
                // Video progress bar logic
                const updateProgressBar = () => {
                    const progress = (videoElement.currentTime / videoElement.duration) * 100;
                    document.querySelector('.h-full.bg-pink-500').style.width = `${progress}%`;
                };

                const handleVideoEnded = () => {
                    handleUnlockNextShort(state.activeShortIndex);
                    if (state.activeShortIndex < state.activeSeries.shorts.length - 1) {
                        updateState({ activeShortIndex: state.activeShortIndex + 1 });
                    }
                };

                videoElement.addEventListener('timeupdate', updateProgressBar);
                videoElement.addEventListener('ended', handleVideoEnded);

                // Swipe/scroll navigation
                let startY = 0;
                const handleTouchStart = (e) => startY = e.touches[0].clientY;
                const handleTouchEnd = (e) => {
                    const deltaY = startY - e.changedTouches[0].clientY;
                    if (Math.abs(deltaY) < 100) return;
                    if (deltaY > 0 && state.activeShortIndex < state.activeSeries.shorts.length - 1) {
                        updateState({ activeShortIndex: state.activeShortIndex + 1 });
                    } else if (deltaY < 0 && state.activeShortIndex > 0) {
                        updateState({ activeShortIndex: state.activeShortIndex - 1 });
                    }
                };
                viewerElement.addEventListener('touchstart', handleTouchStart);
                viewerElement.addEventListener('touchend', handleTouchEnd);
                viewerElement.addEventListener('wheel', (e) => {
                    if (Math.abs(e.deltaY) < 100) return;
                    if (e.deltaY > 0 && state.activeShortIndex < state.activeSeries.shorts.length - 1) {
                        updateState({ activeShortIndex: state.activeShortIndex + 1 });
                    } else if (e.deltaY < 0 && state.activeShortIndex > 0) {
                        updateState({ activeShortIndex: state.activeShortIndex - 1 });
                    }
                });

                // Comment modal textarea update
                if (document.getElementById('comment-textarea')) {
                    document.getElementById('comment-textarea').addEventListener('input', (e) => {
                        state.commentText = e.target.value;
                    });
                }
            }
        };

        // Initial setup on window load
        window.onload = () => {
            // Initial render of loading screen
            render(); 

            // Start async data fetching
            updateState({ lastWatched: getLastWatched() });
            generatePosters();
        };

        // Expose functions to the global scope for onclick events
        window.handleSelectSeries = handleSelectSeries;
        window.handleSelectShort = handleSelectShort;
        window.handleBackFromList = handleBackFromList;
        window.handleExitViewer = handleExitViewer;
        window.togglePlayback = togglePlayback;
        window.handleAnalyzeComment = handleAnalyzeComment;
        window.updateState = updateState;
    </script>
</body>
</html>
